=Iif(Fields!DivisorField.Value = 0, 
    0, 
    Iif(IsNothing(Lookup(Fields!KeyField.Value, Fields!LookupKeyField.Value, Fields!ValueField.Value, "dataset2")), 
        0, 
        (Lookup(Fields!KeyField.Value, Fields!LookupKeyField.Value, Fields!ValueField.Value, "dataset2") + Fields!ValueField.Value) / Fields!DivisorField.Value
    )
)

DECLARE
@reportdate VARCHAR(10) = '20240529'
,@BANK VARCHAR(50)  
--WITH EXEC AS CALLER	    
--AS	    
 
DECLARE @PERIODE INT,@DATE DATE 
SET @DATE = EOMONTH(CONVERT(DATE,@reportdate)) ;
SET @PERIODE = CONVERT(VARCHAR(6),@DATE,112) ;


;WITH NB AS (
SELECT 
	* 
FROM 
	v_PBI_POLICYDIGITAL_DETAIL 
WHERE 
	CONVERT(VARCHAR(6),TRX_DATE ,112)=@PERIODE
)

WITH ISSU AS (
SELECT   A. POLICY_NUMBER,COMPANY='FWD',     A.CHANNEL_CODE,   TRX_DATE, TRX_TYPE, CASES=sum(Cases), APE=sum(APE_PREMIUM), VALUE_TYPE, a.AGENT_ID 
	,P.PRODUCT_ID,P.PRODUCT_DESC,PRODUCT_TYPE,PRODUCT_CATEGORY,a.PARTNERSHIP,a.subchannel 
FROM            v_policyindividu A 
JOIN  v_DIM_PRODUCT P ON P.PRODUCT_ID = A.PRODUCT_ID  
WHERE 1=1  
AND VALUE_TYPE='REAL' 
AND  LEFT(TRX_DATE,6)=@PERIODE 
AND (APE_PREMIUM <> 0 OR CASES <> 0 ) 
and A.CHANNEL_CODE ='ecomm' 
group by   A.CHANNEL_CODE,   TRX_DATE, TRX_TYPE, VALUE_TYPE, a.AGENT_ID 
	,P.PRODUCT_ID,P.PRODUCT_DESC,PRODUCT_TYPE,PRODUCT_CATEGORY,a.PARTNERSHIP,a.subchannel
	,A.POLICY_NUMBER
)

SELECT
	*
FROM
	NB
	FULL OUTER JOIN
	ISSU 
	ON NB.POLICY_NUMBER = ISSU.POLICY_NUMBER
WHERE
	NB.APE <> ISSU.APE
	OR NB.APE IS NULL OR ISSU.APE IS NULL
