=Iif(Fields!DivisorField.Value = 0, 
    0, 
    Iif(IsNothing(Lookup(Fields!KeyField.Value, Fields!LookupKeyField.Value, Fields!ValueField.Value, "dataset2")), 
        0, 
        (Lookup(Fields!KeyField.Value, Fields!LookupKeyField.Value, Fields!ValueField.Value, "dataset2") + Fields!ValueField.Value) / Fields!DivisorField.Value
    )
)


DECLARE @reportdate VARCHAR(10) = '20240529',
        @BANK VARCHAR(50),
        @PERIODE INT,
        @DATE DATE;
        
SET @DATE = EOMONTH(CONVERT(DATE, @reportdate));
SET @PERIODE = CONVERT(VARCHAR(6), @DATE, 112);

;WITH NB AS (
    SELECT 
        * 
    FROM 
        v_PBI_POLICYDIGITAL_DETAIL 
    WHERE 
        CONVERT(VARCHAR(6), TRX_DATE, 112) = @PERIODE
),
ISSU AS (
    SELECT
        A.POLICY_NUMBER,
        COMPANY = 'FWD',
        A.CHANNEL_CODE,
        TRX_DATE,
        TRX_TYPE,
        CASES = SUM(Cases),
        APE = SUM(APE_PREMIUM),
        VALUE_TYPE,
        A.AGENT_ID,
        P.PRODUCT_ID,
        P.PRODUCT_DESC,
        PRODUCT_TYPE,
        PRODUCT_CATEGORY,
        A.PARTNERSHIP,
        a.subchannel 
    FROM
        v_policyindividu A
    JOIN
        v_DIM_PRODUCT P ON P.PRODUCT_ID = A.PRODUCT_ID  
    WHERE
        VALUE_TYPE = 'REAL' 
        AND LEFT(TRX_DATE, 6) = @PERIODE 
        AND (APE_PREMIUM <> 0 OR CASES <> 0) 
        AND A.CHANNEL_CODE = 'ecomm' 
    GROUP BY
        A.CHANNEL_CODE,
        TRX_DATE,
        TRX_TYPE,
        VALUE_TYPE,
        A.AGENT_ID,
        P.PRODUCT_ID,
        P.PRODUCT_DESC,
        PRODUCT_TYPE,
        PRODUCT_CATEGORY,
        A.PARTNERSHIP,
        a.subchannel,
        A.POLICY_NUMBER
)

SELECT
    *
FROM
    NB
FULL OUTER JOIN
    ISSU ON NB.POLICY_NUMBER = ISSU.POLICY_NUMBER
WHERE
    NB.APE <> ISSU.APE
    OR NB.APE IS NULL 
    OR ISSU.APE IS NULL;
