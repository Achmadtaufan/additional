select   
	POLICYNUMBER = cov.CHDRNUM 
	,PLANCODE = CRTABLE 
	,PLAN_TYPE = CASE 
					WHEN cov.LIFE='01' and cov.COVERAGE='01' and cov.RIDER='00' THEN 'PLAN'
					when itempf.tipe is not null then itempf.tipe
					--WHEN cov.LIFE='01' and cov.COVERAGE <> '01' and cov.RIDER='00'  and ( cov.CRTABLE <> 'fwdb'  and cov.CRTABLE not like 'zst%'  )  and FREQ ='' THEN 'BOOSTER'
					ELSE 'RIDER'
				 END
	,LOADINGPREMIUM = ISNULL(ZLINSTPREM ,0)
	,DISCOUNTPREMIUM = ISNULL(ZDINSTPREM  ,0)
	,BASICPREMIUM = CASE WHEN cov.LIFE='01' and cov.COVERAGE='01' and cov.RIDER='00'
					THEN  ISNULL(INSTPREM,0)+ISNULL(SINGP,0) ELSE 0 END
	,TOPUP = CASE 
					WHEN cov.LIFE='01' and cov.COVERAGE <> '01' and cov.RIDER='00' 
						and ( cov.CRTABLE <> 'fwdb'  and cov.CRTABLE not like 'zst%'  )  and FREQ =''
					THEN 
						case when cov.ZBINSTPREM = 0 then cov.INSTPREM else cov.ZBINSTPREM  end
					ELSE 0 
			END
	,RIDERPREMIUM = CASE 
						WHEN cov.LIFE='01' and cov.COVERAGE='01' and cov.RIDER='00' THEN 0 
						WHEN cov.LIFE='01' and cov.COVERAGE <> '01' and cov.RIDER='00' 
							and ( cov.CRTABLE <> 'fwdb'  and cov.CRTABLE not like 'zst%'  )  and FREQ ='' THEN 0 
						ELSE INSTPREM
					END 
	,COVERAGEDEBT =null
	,cov.LIFE,cov.COVERAGE,cov.RIDER, TRANNO=null
	, CURRFROM=null,CURRTO=null
	,COVERAGESTATUS =null
	,PREMIUMSTATUS =null
	,CHANGESTATUSREASON   =null
	,COVERAGECOMMENCEMENTDATE  =null
	,AGEATTAINED  =null
	, SEX=null
	,CURRENCY =null
	,TRANDATE = TRDT
	,TRANTIME = TRTM
	,RISKCESSATIONDATE = RCESDTE 
	,PREMIUMCESSATIONDATE = PCESDTE 
	,BENEFITCESSATIONDATE = BCESDTE 
	,NEXTACTIVITYDATE =null
	,RISKCESSATIONAGE = RCESAGE 
	,PREMIUMCESSATIONAGE = PCESAGE 
	,BENEFITCESSATIONAGE = BCESAGE 
	,RISKTERM = RCESTRM 
	,PREMIUMTERM = PCESTRM 
	,BENEFITTERM = BCESTRM 
	,SUMINS
	,PLNSFX
	,CURRENCYCODE=null
	,MORTALITYCLASS = MORTCLS 
	,MATURITYVALUE =null 
	,MATURITYDATE =null
	,MATURITYINTEREST =null
	,CAMPAIGN	
	,PAIDTODATE =null
	,ZPTDATEPC=null
	,STATUSCHANGEDATE =null
	,PREMIUMSTATUSDATE =null
	,USRPRF
	,DATIME
	,COV.AUD_Type
	,cov.AUD_time ,SOURCEOFDATA = 'AS400'
from STG_COVtPF cov (nolock ) 
join ( 
	SELECT ID = max(ID),CHDRNUM ,COVERAGE,LIFE,RIDER  FROM STG_COVtPF cov2 (NOLOCK)  
	WHERE 1=1 
	AND cov2.AUD_TYPE NOT IN ( 'CB','ub' )  
	and cov2.CHDRNUM <> ''
	group by CHDRNUM ,COVERAGE,LIFE,RIDER
)cov2  on   cov2.CHDRNUM  = cov.CHDRNUM 
	and cov2.LIFE=cov.LIFE and cov2.COVERAGE=cov.COVERAGE and cov2.RIDER=cov.RIDER and cov2.ID = cov.ID
left join (
	select   
		RTRIM(a.DESCITEM) AS ITEMCODE, 
		tipe =  case when a.DESCITEM like '%st%' or a.LONGDESC like '%sing%' or a.LONGDESC like '%boost%'  then 'STU' else 'RTU' end 
    
	from 
	stg_descpf a WITH(NOLOCK) 
	WHERE 1=1 
	and a.DESCTABL='T5646'
	and a.aud_type not in ('CB')  and a.AUD_Time is not null 
	and RTRIM(a.DESCCOY) <> '' and RTRIM(a.DESCTABL) <> '' 
	and RTRIM(a.DESCITEM) <> '' and RTRIM(a.LANGUAGE) <> ''
	and RTRIM(a.LANGUAGE) ='e'
	and  (RTRIM(a.LONGDESC) like '%top up%' or  RTRIM(a.LONGDESC) like '%boost%')
)itempf on itempf.ITEMCODE = cov.CRTABLE
WHERE 1=1    
AND cov.CHDRNUM='C0288554'
