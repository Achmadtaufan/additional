IF (OBJECT_ID('TEMPDB..#TEMP_LF_PAYOUTBANKACCOUNT') IS NOT NULL)                
BEGIN                
 DROP TABLE TEMPDB..#TEMP_LF_PAYOUTBANKACCOUNT                
END                 
                
SELECT *                 
INTO #TEMP_LF_PAYOUTBANKACCOUNT                
FROM LF_PAYOUTBANKACCOUNT  WITH(NOLOCK) WHERE 1=1                     
AND REQNTYPE IN ('4','R') AND (PROCIND IN ('AU','PR') AND (AUTHDATE <>'0' OR AUTHDATE IS NOT NULL) AND AUD_TYPE<>'DL' )     
                
                
IF (OBJECT_ID('TEMPDB..#TEMP_LF_PAYOUTBANKACCOUNT2') IS NOT NULL)                
BEGIN                
 DROP TABLE TEMPDB..#TEMP_LF_PAYOUTBANKACCOUNT2                
END                 
                
SELECT *                 
INTO #TEMP_LF_PAYOUTBANKACCOUNT2                
FROM LF_PAYOUTBANKACCOUNT  WITH(NOLOCK) WHERE 1=1                     
AND REQNTYPE IN ('4','R') AND (PROCIND = 'RC' AND (AUTHDATE <>'0' OR AUTHDATE IS NOT NULL) AND AUD_TYPE<>'DL' )     
    
    
IF (OBJECT_ID('TEMPDB..#TEMP_STG_LFCLNTBANKACC') IS NOT NULL)                
BEGIN                
 DROP TABLE TEMPDB..#TEMP_STG_LFCLNTBANKACC                
END        
    
SELECT A.*  INTO #TEMP_STG_LFCLNTBANKACC FROM STG..STG_LFCLNTBANKACC AS A WITH(NOLOCK)
	 JOIN ( SELECT B.CLNTNUM, B.DATIME, B.AUD_Time, MAX(CURRFROM) AS CURRFROM, MAX(CURRTO) AS CURRTO FROM STG..STG_LFCLNTBANKACC AS B WITH(NOLOCK)
	        INNER JOIN ( SELECT MAX(DATIME) AS DATIME, MAX(AUD_Time) AS AUD_Time, CLNTNUM 
			             FROM  STG..STG_LFCLNTBANKACC A WITH(NOLOCK)
			             GROUP BY CLNTNUM 
				       ) X 
		          ON B.CLNTNUM=X.CLNTNUM AND B.DATIME=X.DATIME AND B.AUD_Time=x.AUD_Time 
		    GROUP BY B.CLNTNUM, B.DATIME, B.AUD_Time
		  ) Y 
	 ON Y.CLNTNUM=A.CLNTNUM AND Y.DATIME=A.DATIME AND Y.AUD_Time=A.AUD_Time AND Y.CURRFROM=A.CURRFROM AND Y.CURRTO=A.CURRTO
      
IF (OBJECT_ID('TEMPDB..#TEMP_ROWDATA') IS NOT NULL)                
BEGIN                
 DROP TABLE TEMPDB..#TEMP_ROWDATA                
END                 
                
SELECT DISTINCT --TOP 10                     
A.REQUESTOR AS USER_ID, U.GROUPNAME AS DEPARTMENT                    
,D.LONGDESC AS PARTNER, POL.POLICY_NUMBER, A.REQNNO AS PAYMENT_NUMBER,                    
    CASE WHEN A.SUB_ACC_TYPE = 'DS' THEN 'DIVIDEND'                    
         WHEN A.SUB_ACC_TYPE = 'MS' THEN 'MATURITY'                    
         WHEN A.SUB_ACC_TYPE = 'PS' THEN 'FREELOOK'                    
         WHEN A.SUB_ACC_TYPE = 'SO' AND POL.POLICY_STATUS = 'IF' THEN 'WITHDRAWAL'                    
         WHEN A.SUB_ACC_TYPE = 'SO' AND POL.POLICY_STATUS = 'SU' THEN 'SURRENDER'                    
         WHEN A.SUB_ACC_TYPE = 'NS' THEN 'REFUND CONTRACT SUSPENSE'                    
         WHEN A.SUB_ACC_TYPE = 'LS' THEN 'POLICY LOAN'                    
         WHEN A.SUB_ACC_TYPE = 'CB' THEN 'NCB'                    
         WHEN A.SUB_ACC_TYPE = 'EZ' THEN 'TAHAPAN'                    
         WHEN A.SUB_ACC_TYPE = 'SR' THEN 'ROP'                    
         WHEN A.SUB_ACC_TYPE = 'SL' THEN 'AUTO SURRENDER'                    
         WHEN A.SUB_ACC_TYPE = 'S' THEN 'REFUND PREMIUM'                    
    ELSE X.LONGDESC                     
 END AS TYPE,                    
 A.SUB_ACC_TYPE,                    
 A.CURRENCY_RATE EXCHANGE_RATE,                    
 A.PAYCURR CURRENCY,ISNULL(C.BNKACTYP,'') BANKACCOUNTTYPE,                    
    CASE WHEN A.PAYCURR <> 'IDR' THEN A.PAYAMT ELSE '0' END AMOUNT_USD,                    
    CASE WHEN A.PAYCURR = 'IDR' THEN A.PAYAMT ELSE '0' END AMOUNT_IDR,                    
 ISNULL(C.BANKACCDSC,'') AS BENEF_NAME,                    
    A.BANKKEY AS BENEF_BANK,                     
    ISNULL(F.LONGDESC,'') AS BENEF_BANK_NAME,           
    '' AS SWIFTCODE,                     
    A.BANKACCKEY AS BENEF_ACCOUNT,                                
 CAST(CONVERT(VARCHAR(8),CASE WHEN ISNULL(CAST(A.REQDATE AS VARCHAR),'0') = '0' OR  CAST(A.REQDATE AS VARCHAR) ='99999999'THEN '19000101' ELSE CAST(A.REQDATE AS VARCHAR) END,120) AS DATE) AS RQ_CREATE_DATE,                  
    CAST(CONVERT(VARCHAR(8),CASE WHEN ISNULL(CAST(A.APPROVEDDATE AS VARCHAR),'0') = '0' OR  CAST(A.APPROVEDDATE AS VARCHAR) ='99999999'THEN '19000101' ELSE CAST(A.APPROVEDDATE AS VARCHAR) END,120) AS DATE) AS RQ_APPROVED_DATE,                  
    ISNULL(A.APPROVEDBY,'') AS APPROVED_USER, ISNULL(A.AUTHORIZEDBY,'') AS AUTHORISED_USER,                    
   
   CAST(CONVERT(VARCHAR(8),CASE WHEN ISNULL(CAST(A.AUTHDATE AS VARCHAR),'0') = '0' OR  CAST(A.AUTHDATE AS VARCHAR) ='99999999'THEN '19000101' ELSE CAST(A.AUTHDATE AS VARCHAR) END,120) AS DATE) AS RQ_AUTHORISED_DATE,                  
   A.REVIND REVERSAL,A.REQNTYPE,A.PROCIND PROCESS_INDICATOR, A.REQNREV RQ_REVERSAL,CAST(A.DATIME AS VARCHAR) AS UPDATE_TIMESTAMP,                    
 CASE                     
  WHEN A.PROCIND='PR' AND REVIND='Y' THEN 'Reversal'                    
  WHEN (A.REQNTYPE IN ('4','R') AND A.PROCIND='PR') OR A.PROCIND='AU' THEN 'Payment Authorise'                    
  WHEN A.PROCIND='RC' THEN 'Reject'                    
  ELSE ''                    
 END AS PAYMENT_STATUS
 	----UR-2024-12-0013, ADDED BY TAUFAN, 2025-01-30	
   --, A.CLNTNUM01 CLIENT_ID 
   ,CLM.CLIENT_ID
	----END CHANGES
                 
INTO #TEMP_ROWDATA                    
FROM (                    
  SELECT A.*,B.SUB_ACC_TYPE SUB_ACC_TYPE,B.CURRENCY_RATE,B.SUB_LEDGER_ACCOUNT_ENTITY,B.TRANS_DESCRIPTION                 
  FROM #TEMP_LF_PAYOUTBANKACCOUNT A             
  JOIN LF_ACCOUNTMOVEMENT B  WITH(NOLOCK)  ON A.REQNNO=B.DOC_NUM AND A.COMPANY_CODE=B.DOC_COMPANY AND A.PAYAMT=B.ORI_AMOUNT_CURRENCY     
     UNION                    
  SELECT A.*,B.SUB_ACC_TYPE SUB_ACC_TYPE,C.CURRENCY_RATE,C.SUB_LEDGER_ACCOUNT_ENTITY,C.TRANS_DESCRIPTION                
  FROM #TEMP_LF_PAYOUTBANKACCOUNT2 A                    
  JOIN LF_PAYMENTREQUEST B  WITH(NOLOCK)  ON A.REQNNO=B.PAYMENT_NO AND A.COMPANY_CODE=B.COMPANY_CODE AND B.AUD_Type<>'DL'
  JOIN LF_ACCOUNTMOVEMENT C  WITH(NOLOCK)  ON A.REQNNO=C.DOC_NUM AND A.COMPANY_CODE=C.DOC_COMPANY AND A.PAYAMT=C.ORI_AMOUNT_CURRENCY 
  )A                  
JOIN TR_POLICY POL WITH(NOLOCK) ON LEFT(A.SUB_LEDGER_ACCOUNT_ENTITY,8)=POL.POLICY_NUMBER AND A.COMPANY_CODE=POL.COMPANY_CODE                    
LEFT JOIN #TEMP_STG_LFCLNTBANKACC C  ON LTRIM(RTRIM(A.CLNTNUM01))=LTRIM(RTRIM(C.CLNTNUM)) AND LTRIM(RTRIM(A.BANKACCKEY))=LTRIM(RTRIM(C.BANKACCKEY)) AND LTRIM(RTRIM(A.BANKKEY))=LTRIM(RTRIM(C.BANKKEY)) AND A.FACTHOUS=C.FACTHOUS                
LEFT JOIN LF_USERDEPT AS U WITH(NOLOCK) ON U.USERID=A.REQUESTOR                    
LEFT JOIN (SELECT * FROM la_itemDESC WITH(NOLOCK) WHERE ITEMTABLE='T3615' AND LANGUAGE='E') D ON D.ITEMCODE=POL.SOURCEOFBUSINESS                    
LEFT JOIN (SELECT * FROM la_itemDESC WITH(NOLOCK) WHERE ITEMTABLE='T3695' AND LANGUAGE='E') X ON X.ITEMCODE=A.SUB_ACC_TYPE                     
LEFT JOIN (SELECT * FROM la_itemDESC WITH(NOLOCK) WHERE ITEMTABLE='TR338' AND LANGUAGE='E' ) F ON F.ITEMCODE=C.BNKACTYP  
LEFT JOIN VW_CLAIM_DETAIL CLM WITH(NOLOCK) ON CLM.POLICY_NUMBER=LEFT(A.SUB_LEDGER_ACCOUNT_ENTITY,8) AND RTRIM(LTRIM(A.TRANS_DESCRIPTION))=RTRIM(LTRIM(CLM.CLAIM_ID))
                
                
IF (OBJECT_ID('TEMPDB..#TEMP_LIFEASSURED') IS NOT NULL)                
BEGIN                
 DROP TABLE TEMPDB..#TEMP_LIFEASSURED                
END                 
                
SELECT DISTINCT POL.POLICY_NUMBER,
----UR-2024-12-0013, ADDED BY TAUFAN, 2025-01-30
CASE WHEN RD.DEPARTMENT LIKE '%CLM%' THEN RD.CLIENT_ID ELSE INS.CLIENT_ID END AS CLIENT_ID,                     
CASE WHEN RD.DEPARTMENT LIKE '%CLM%' THEN RTRIM(LTRIM(RTRIM(LTRIM(CLM.FIRST_NAME)) + ' ' + RTRIM(LTRIM(CLM.MIDDLE_NAME)) + ' ' + RTRIM(LTRIM(CLM.SURNAME))))
ELSE RTRIM(LTRIM(RTRIM(LTRIM(INS.FIRST_NAME)) + ' ' + RTRIM(LTRIM(INS.MIDDLE_NAME)) + ' ' + RTRIM(LTRIM(INS.SURNAME)))) END AS INSURED_NAME,
--RTRIM(LTRIM(RTRIM(LTRIM(INS.FIRST_NAME)) + ' ' + RTRIM(LTRIM(INS.MIDDLE_NAME)) + ' ' + RTRIM(LTRIM(INS.SURNAME)))) INSURED_NAME,
----END CHANGES
PH.CLIENT_ID PH_CLIENTID,RTRIM(LTRIM(RTRIM(LTRIM(PH.FIRST_NAME)) + ' ' + RTRIM(LTRIM(PH.MIDDLE_NAME)) + ' ' + RTRIM(LTRIM(PH.SURNAME)))) AS PH_NAME
INTO #TEMP_LIFEASSURED                
FROM #TEMP_ROWDATA RD                 
LEFT JOIN TR_POLICY POL  WITH(NOLOCK) ON RD.POLICY_NUMBER=POL.POLICY_NUMBER  
LEFT JOIN LF_CLIENT PH WITH(NOLOCK) ON POL.CLIENT_ID=PH.CLIENT_ID 
LEFT JOIN LF_CLIENT CLM WITH(NOLOCK) ON RD.CLIENT_ID=CLM.CLIENT_ID 
LEFT JOIN LF_CLIENT INS WITH(NOLOCK) ON POL.INSURED_ID=INS.CLIENT_ID                        
                
IF (OBJECT_ID('TEMPDB..#SWIFTCODE') IS NOT NULL)                
BEGIN                
 DROP TABLE TEMPDB..#SWIFTCODE                
END                 
                
                
SELECT *                 
INTO #SWIFTCODE                
FROM (                   
 SELECT DISTINCT                     
 ITEMCODE AS BANKTYPE, TRIM(SUBSTRING(GENAREA,1,3)) CURRENCY,                     
 TRIM(SUBSTRING(GENAREA,46,15)) AS SWIFTCODE                    
    FROM LA_ITEMDESC WITH(NOLOCK)                    
    WHERE ITEMTABLE = 'TY680'                     
 UNION ALL                    
 SELECT DISTINCT                     
 ITEMCODE AS BANKTYPE, TRIM(SUBSTRING(GENAREA,4,3)) CURRENCY,                     
 TRIM(SUBSTRING(GENAREA,61,15)) AS SWIFTCODE                    
    FROM LA_ITEMDESC  WITH(NOLOCK)                    
    WHERE ITEMTABLE = 'TY680'                     
)X                   
                
            
            
--IF (OBJECT_ID('DBREPORT.dbo.REPORT_RQ_AUTHORIZED_COMPLETED_UAT') IS NOT NULL)                
--BEGIN                
-- DROP TABLE DBREPORT.dbo.REPORT_RQ_AUTHORIZED_COMPLETED_UAT                
--END             

IF (OBJECT_ID('TEMPDB..#REPORT_RQ_AUTHORIZED_COMPLETED_UAT') IS NOT NULL)                
BEGIN                
 DROP TABLE TEMPDB..#REPORT_RQ_AUTHORIZED_COMPLETED_UAT                
END   
        
                
SELECT                    
A.USER_ID, A.DEPARTMENT, A.PARTNER, A.POLICY_NUMBER, A.PAYMENT_NUMBER, A.TYPE,
B.INSURED_NAME, A.EXCHANGE_RATE, A.AMOUNT_USD, A.AMOUNT_IDR,                    
A.BENEF_NAME, A.BENEF_BANK, A.BENEF_BANK_NAME, C.SWIFTCODE, A.BENEF_ACCOUNT,A.CURRENCY,A.RQ_CREATE_DATE,A.RQ_APPROVED_DATE,A.APPROVED_USER,A.RQ_AUTHORISED_DATE,A.AUTHORISED_USER                    
, A.REVERSAL,A.RQ_REVERSAL,A.PAYMENT_STATUS,
----UR-2024-12-0013, ADDED BY TAUFAN, 2025-01-30
B.PH_NAME POLICY_OWNER_NAME             
----END CHANGES
--INTO DBREPORT.dbo.REPORT_RQ_AUTHORIZED_COMPLETED_UAT
INTO TEMPDB..#REPORT_RQ_AUTHORIZED_COMPLETED_UAT
FROM #TEMP_ROWDATA A                    
JOIN #TEMP_LIFEASSURED B ON A.POLICY_NUMBER = B.POLICY_NUMBER AND A.CLIENT_ID=B.CLIENT_ID                   
LEFT JOIN #SWIFTCODE C ON                     
    (CASE                     
        WHEN A.CURRENCY = 'IDR' THEN 'IDR' ELSE '***' END = C.CURRENCY) AND A.BANKACCOUNTTYPE = C.BANKTYPE 
