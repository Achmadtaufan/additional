DECLARE @n INT = 10; -- Ubah sesuai kebutuhan
DECLARE @sql NVARCHAR(MAX);
DECLARE @cols NVARCHAR(MAX);

-- Buat daftar kolom untuk PIVOT
SET @cols = STUFF((SELECT DISTINCT ',' + QUOTENAME(rn)
                   FROM (
                       SELECT ROW_NUMBER() OVER (PARTITION BY policy_number ORDER BY plan_code) AS rn
                       FROM tr_policyproduct
                       WHERE plan_type = 'rider' AND policy_number IN (SELECT policy_number FROM #eead)
                   ) AS x
                   WHERE rn <= @n
                   FOR XML PATH('')), 1, 1, '');

-- Buat query PIVOT secara dinamis
SET @sql = N'SELECT policy_number, ' + @cols + '
            FROM 
            (
                SELECT 
                    policy_number,
                    plan_code,
                    ROW_NUMBER() OVER (PARTITION BY policy_number ORDER BY plan_code) AS rn
                FROM 
                    tr_policyproduct
                WHERE 
                    plan_type = ''rider'' AND policy_number IN (SELECT policy_number FROM #eead)
            ) AS src
            PIVOT 
            (
                MAX(plan_code) 
                FOR rn IN (' + @cols + ')
            ) AS pvt
            ORDER BY policy_number;';

-- Eksekusi query
EXEC sp_executesql @sql;
