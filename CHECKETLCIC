SELECT  
	CLN.VALUE [LEADNAME],
	--GENDER, 
	CL.MOBILENUMBER [LEADMOBILENUMBER], 
	[EMAILADDRESS] [LEADEMAIL],
	CONVERT(VARCHAR,BIRTHDATE) [LEADBIRTHDAY], 
    [PRODUCTINTERESTEDTYPECODE] [PRODUCTCATEGORY],
	CAST(A.ACTIVITY_TYPE  AS VARCHAR(10))
	[LEADSTATUS],
	'IRIS LEADS' [CAMPAIGNNAME],
	CONVERT(VARCHAR,CL.CREATEDATE) [LEADCREATEDDATE], AGENTCODE [FOLLOWUPBY],
	UPDATEDDATE = GETDATE() 
FROM 
	(
		SELECT 
			 LEAD_ID
			,PROPERTY_NAME
			,PROPERTY_VALUE_STR
		FROM 
			LEAD.DBO.CCR_LEAD_PROFILE
	) A
    PIVOT
    (
		MAX(A.PROPERTY_VALUE_STR) FOR A.PROPERTY_NAME IN (
																[EMAILADDRESS]
															,[AFFILIATEPOSTID]
															,[AFFILIATEPOSTLINK]
															,[PREFERREDLOCNAME]
															,[AFFILIATECODE]
															,[AFFILIATESHAREDMEDIA]
															,[PRODUCTINTERESTEDTYPECODE]
															)
    ) P 
    INNER JOIN   
	LEAD.DBO.CCR_LEAD CL 
	ON	P.LEAD_ID=CL.LEAD_ID 
		AND CL.SOURCE = 'I'
    INNER JOIN 
	LEAD.DBO.CCR_LEAD_NAME CLN 
	ON	CLN.LEAD_ID=P.LEAD_ID
        AND CLN.LANGUAGE='EN' 
    INNER JOIN
    (
		SELECT 
			RANK() OVER (PARTITION BY LEAD_ID ORDER BY LAST_UPDATE_DATE DESC) RANK_R,*
		FROM 
			IRIS.DBO.LEAD_ACTIVITY_LOG 
	) A  
	ON	A.LEAD_ID =P.LEAD_ID 
		AND A.RANK_R=1
