-- Membuat temporary table untuk menyimpan nama link server
CREATE TABLE #LinkServers (LinkServerName NVARCHAR(100))

-- Memasukkan nama link server yang dimiliki oleh server idnlolita ke dalam temporary table
INSERT INTO #LinkServers (LinkServerName)
SELECT name
FROM sys.servers
WHERE is_linked = 1

-- Membuat temporary table untuk menyimpan hasil pencarian objek
CREATE TABLE #ObjectsWithLinkServer (DatabaseName NVARCHAR(100), ObjectType NVARCHAR(50), ObjectName NVARCHAR(100))

-- Loop melalui setiap database untuk mencari objek yang memiliki nama link server
DECLARE @DatabaseName NVARCHAR(100)
DECLARE @LinkServerName NVARCHAR(100)
DECLARE @SQL NVARCHAR(MAX)

DECLARE db_cursor CURSOR FOR
SELECT name
FROM sys.databases
WHERE state_desc = 'ONLINE' -- Hanya database yang online

OPEN db_cursor
FETCH NEXT FROM db_cursor INTO @DatabaseName

WHILE @@FETCH_STATUS = 0
BEGIN
    -- Loop melalui setiap nama link server
    DECLARE link_cursor CURSOR FOR
    SELECT LinkServerName
    FROM #LinkServers

    OPEN link_cursor
    FETCH NEXT FROM link_cursor INTO @LinkServerName

    WHILE @@FETCH_STATUS = 0
    BEGIN
        SET @SQL = '
            USE ' + QUOTENAME(@DatabaseName) + ';

            INSERT INTO #ObjectsWithLinkServer (DatabaseName, ObjectType, ObjectName)
            SELECT 
                DB_NAME() AS DatabaseName,
                CASE 
                    WHEN type_desc = ''VIEW'' THEN ''View''
                    WHEN type_desc = ''SQL_STORED_PROCEDURE'' THEN ''Stored Procedure''
                    WHEN type_desc = ''SQL_INLINE_TABLE_VALUED_FUNCTION'' THEN ''Inline Table-Valued Function''
                    WHEN type_desc = ''SQL_SCALAR_FUNCTION'' THEN ''Scalar Function''
                    ELSE ''Other''
                END AS ObjectType,
                QUOTENAME(name) AS ObjectName
            FROM sys.objects
            WHERE
                type IN (''V'', ''P'', ''FN'', ''IF'') AND
                OBJECT_DEFINITION(object_id) LIKE ''%'' + @LinkServerName + ''%''
        '

        EXEC sp_executesql @SQL, N'@LinkServerName NVARCHAR(100)', @LinkServerName

        FETCH NEXT FROM link_cursor INTO @LinkServerName
    END

    CLOSE link_cursor
    DEALLOCATE link_cursor

    FETCH NEXT FROM db_cursor INTO @DatabaseName
END

CLOSE db_cursor
DEALLOCATE db_cursor

-- Menampilkan hasil pencarian
SELECT *
FROM #ObjectsWithLinkServer

-- Menghapus temporary tables
DROP TABLE #LinkServers
DROP TABLE #ObjectsWithLinkServer
