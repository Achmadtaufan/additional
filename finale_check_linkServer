-- Membuat temporary table untuk menyimpan nama link server
CREATE TABLE #LinkServers (LinkServerName NVARCHAR(100))

-- Memasukkan nama link server yang dimiliki oleh server idnlolita ke dalam temporary table
INSERT INTO #LinkServers (LinkServerName)
SELECT name
FROM sys.servers
WHERE is_linked = 1

-- Membuat temporary table untuk menyimpan hasil pencarian objek
CREATE TABLE #ObjectsWithLinkServer (DatabaseName NVARCHAR(100), ObjectType NVARCHAR(50), ObjectName NVARCHAR(100))

-- Membuat temporary table untuk menyimpan database yang tidak dapat diakses oleh pengguna svc_dwh
CREATE TABLE #ExcludedDatabases (DatabaseName NVARCHAR(100))

-- Memasukkan nama database yang tidak dapat diakses oleh pengguna svc_dwh ke dalam temporary table
INSERT INTO #ExcludedDatabases (DatabaseName)
SELECT d.name
FROM sys.databases d
WHERE NOT EXISTS (
    SELECT 1
    FROM sys.database_principals dp
    JOIN sys.server_principals sp ON dp.sid = sp.sid
    WHERE dp.name = 'svc_dwh' AND sp.type_desc = 'SQL_USER'
    ) OR NOT EXISTS (
    SELECT 1
    FROM sys.database_role_members drm
    JOIN sys.database_principals dp ON drm.member_principal_id = dp.principal_id
    JOIN sys.server_principals sp ON dp.sid = sp.sid
    WHERE sp.name = 'svc_dwh'
    )

-- Loop melalui setiap database untuk mencari objek yang memiliki nama link server
DECLARE @DatabaseName NVARCHAR(100)
DECLARE @LinkServerName NVARCHAR(100)
DECLARE @SQL NVARCHAR(MAX)

DECLARE db_cursor CURSOR FOR
SELECT name
FROM sys.databases
WHERE state_desc = 'ONLINE' AND name NOT IN (SELECT DatabaseName FROM #ExcludedDatabases) -- Mengabaikan database yang tidak dapat diakses oleh pengguna svc_dwh

OPEN db_cursor
FETCH NEXT FROM db_cursor INTO @DatabaseName

WHILE @@FETCH_STATUS = 0
BEGIN
    -- Loop melalui setiap nama link server
    DECLARE link_cursor CURSOR FOR
    SELECT LinkServerName
    FROM #LinkServers

    OPEN link_cursor
    FETCH NEXT FROM link_cursor INTO @LinkServerName

    WHILE @@FETCH_STATUS = 0
    BEGIN
        SET @SQL = '
            USE ' + QUOTENAME(@DatabaseName) + ';

            INSERT INTO #ObjectsWithLinkServer (DatabaseName, ObjectType, ObjectName)
            SELECT 
                DB_NAME() AS DatabaseName,
                CASE 
                    WHEN type_desc = ''VIEW'' THEN ''View''
                    WHEN type_desc = ''SQL_STORED_PROCEDURE'' THEN ''Stored Procedure''
                    WHEN type_desc = ''SQL_INLINE_TABLE_VALUED_FUNCTION'' THEN ''Inline Table-Valued Function''
                    WHEN type_desc = ''SQL_SCALAR_FUNCTION'' THEN ''Scalar Function''
                    ELSE ''Other''
                END AS ObjectType,
                QUOTENAME(name) AS ObjectName
            FROM sys.objects
            WHERE
                type IN (''V'', ''P'', ''FN'', ''IF'') AND
                OBJECT_DEFINITION(object_id) LIKE ''%'' + @LinkServerName + ''%''
        '

        EXEC sp_executesql @SQL, N'@LinkServerName NVARCHAR(100)', @LinkServerName

        FETCH NEXT FROM link_cursor INTO @LinkServerName
    END

    CLOSE link_cursor
    DEALLOCATE link_cursor

    FETCH NEXT FROM db_cursor INTO @DatabaseName
END

CLOSE db_cursor
DEALLOCATE db_cursor

-- Menampilkan hasil pencarian
SELECT *
FROM #ObjectsWithLinkServer

-- Menghapus temporary tables
DROP TABLE #LinkServers
DROP TABLE #ObjectsWithLinkServer
DROP TABLE #ExcludedDatabases
