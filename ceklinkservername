-- 1. Buat tabel sementara untuk menyimpan nama-nama linked server
CREATE TABLE #LinkedServers (
    LinkedServerName NVARCHAR(128)
);

-- 2. Ambil nama-nama linked server yang ada di SQL Server
INSERT INTO #LinkedServers (LinkedServerName)
SELECT name
FROM sys.servers
WHERE is_linked = 1;

-- 3. Tentukan variabel database yang ingin dicek
DECLARE @DatabaseName NVARCHAR(128) = 'fwd_microservice'; -- Ganti dengan nama database yang ingin Anda cek

-- 4. Buat tabel sementara untuk menyimpan hasil pencarian
CREATE TABLE #LinkedServerReferences (
    ObjectType NVARCHAR(60),
    ObjectName NVARCHAR(128),
    LinkedServerName NVARCHAR(128)
);

-- 5. Cari linked server name dalam view
INSERT INTO #LinkedServerReferences (ObjectType, ObjectName, LinkedServerName)
SELECT 'VIEW', v.name, ls.LinkedServerName
FROM sys.views v
JOIN sys.sql_modules m ON v.object_id = m.object_id
JOIN #LinkedServers ls ON m.definition LIKE '%[' + ls.LinkedServerName + ']%'
WHERE v.type = 'V'
AND DB_NAME(DB_ID()) = @DatabaseName;

-- 6. Cari linked server name dalam stored procedure
INSERT INTO #LinkedServerReferences (ObjectType, ObjectName, LinkedServerName)
SELECT 'PROCEDURE', p.name, ls.LinkedServerName
FROM sys.procedures p
JOIN sys.sql_modules m ON p.object_id = m.object_id
JOIN #LinkedServers ls ON m.definition LIKE '%[' + ls.LinkedServerName + ']%'
WHERE DB_NAME(DB_ID()) = @DatabaseName;

-- 7. Cari linked server name dalam function
INSERT INTO #LinkedServerReferences (ObjectType, ObjectName, LinkedServerName)
SELECT 'FUNCTION', f.name, ls.LinkedServerName
FROM sys.objects f
JOIN sys.sql_modules m ON f.object_id = m.object_id
JOIN #LinkedServers ls ON m.definition LIKE '%[' + ls.LinkedServerName + ']%'
WHERE f.type IN ('FN', 'IF', 'TF')
AND DB_NAME(DB_ID()) = @DatabaseName;

-- 8. Tampilkan hasil pengecekan
SELECT *
FROM #LinkedServerReferences;

-- 9. Hapus tabel sementara jika sudah tidak diperlukan
DROP TABLE #LinkedServers;
DROP TABLE #LinkedServerReferences;
