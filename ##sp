DECLARE @CurrentDate DATE = GETDATE()

-- Hapus tabel sementara jika ada
IF OBJECT_ID('TEMPDB..#TEMP_NEWRECRUIT') IS NOT NULL 
BEGIN
    DROP TABLE #TEMP_NEWRECRUIT  
END

-- Buat tabel sementara untuk NEW RECRUIT
IF DAY(@CurrentDate) = 1
BEGIN
    SELECT 
        A.AGENT_ID AS [AGENTID],
        A.AGENT_NAME,
        A.NEWRECRUIT_EFFECTIVEDATE AS [EFFECTIVEDATE],
        CONVERT(VARCHAR(6), A.NEWRECRUIT_EFFECTIVEDATE, 112) AS [PERIODE]
    INTO #TEMP_NEWRECRUIT
    FROM DM_AGENTS A WITH (NOLOCK)   
    WHERE CONVERT(VARCHAR(6), A.NEWRECRUIT_EFFECTIVEDATE, 112) = CONVERT(VARCHAR(6), DATEADD(MONTH, -1, @CurrentDate), 112)
END
ELSE
BEGIN
    SELECT 
        A.AGENT_ID AS [AGENTID],
        A.AGENT_NAME,
        A.NEWRECRUIT_EFFECTIVEDATE AS [EFFECTIVEDATE],
        CONVERT(VARCHAR(6), A.NEWRECRUIT_EFFECTIVEDATE, 112) AS [PERIODE]
    INTO #TEMP_NEWRECRUIT
    FROM DM_AGENTS A WITH (NOLOCK)   
    WHERE CONVERT(VARCHAR(6), A.NEWRECRUIT_EFFECTIVEDATE, 112) = CONVERT(VARCHAR(6), @CurrentDate, 112)
END

-- Hapus tabel sementara jika ada
IF OBJECT_ID('TEMPDB..#TEMP_MG_AGENTDATA2_V_ADHOC') IS NOT NULL 
BEGIN
    DROP TABLE #TEMP_MG_AGENTDATA2_V_ADHOC  
END

-- Buat tabel sementara untuk data tunjangan
SELECT DISTINCT 
    AGENTID, 
    TUNJANGANFLAG 
INTO #TEMP_MG_AGENTDATA2_V_ADHOC 
FROM MG_AGENTDATA2_V_ADHOC

-- Hapus tabel hasil jika ada
IF OBJECT_ID('TEMPDB..#RESULT') IS NOT NULL 
BEGIN
    DROP TABLE #RESULT  
END

-- Query utama
SELECT
    AG.AGENT_ID AS [AGENTID],
    AG.NEWRECRUIT_EFFECTIVEDATE AS [EFFECTIVEDATE],
    AG2.AGENT_NAME AS [Agent Name],
    AG2.AGENT_STATUS AS [Status],
    AG2.AGENT_LEVEL AS [Agent Level],
    AG2.FWO_ID AS [FWO],
    AG2.FWO AS [FWO Name],
    AG2.FWM_ID AS [FWM],
    AG2.FWM AS [FWM Name],
    AG2.FWD_ID AS [FWD],
    AG2.FWD AS [FWD Name],
    AG2.RECRUITER_ID AS [Recruiter],
    AG2.RECRUITER AS [Recruiter Name],
    RC.AGENT_LEVEL AS [Recruiter Level],
    AG2.SD AS [AH],
    AG2.NSD AS [RAH],
    AG2.JUMBO AS [Jumbo],
    AG2.REGION AS [Region],
    AGR.TUNJANGANFLAG AS [Tunjangan Agent],
    AGR1.TUNJANGANFLAG AS [Tunjangan Recruiter]
INTO #RESULT
FROM #TEMP_NEWRECRUIT A
LEFT JOIN DM_AGENTS AG ON A.AGENTID = AG.AGENT_ID
LEFT JOIN DM_AGENT_2 AG2 ON AG.AGENT_ID = AG2.AGENT_ID
LEFT JOIN DM_AGENTS RC ON AG2.RECRUITER_ID = RC.AGENT_ID
LEFT JOIN #TEMP_MG_AGENTDATA2_V_ADHOC AGR ON AGR.AGENTID = AG.AGENT_ID
LEFT JOIN #TEMP_MG_AGENTDATA2_V_ADHOC AGR1 ON AGR1.AGENTID = RC.AGENT_ID
ORDER BY AG.NEWRECRUIT_EFFECTIVEDATE, AG.AGENT_ID

-- Output hasil
IF (SELECT COUNT(*) FROM #RESULT) > 0     
BEGIN     
    SELECT * 
    FROM #RESULT 
    ORDER BY EFFECTIVEDATE, AGENTID
END     
ELSE      
BEGIN      
    SELECT  
        NULL AS [AGENTID],
        NULL AS [EFFECTIVEDATE],
        NULL AS [Agent Name],
        NULL AS [Status],
        NULL AS [Agent Level],
        NULL AS [FWO],
        NULL AS [FWO Name],
        NULL AS [FWM],
        NULL AS [FWM Name],
        NULL AS [FWD],
        NULL AS [FWD Name],
        NULL AS [Recruiter],
        NULL AS [Recruiter Name],
        NULL AS [Recruiter Level],
        NULL AS [AH],
        NULL AS [RAH],
        NULL AS [Jumbo],
        NULL AS [Region],
        NULL AS [Tunjangan Agent],
        NULL AS [Tunjangan Recruiter]
END     

-- Hapus tabel sementara
DROP TABLE #RESULT;
DROP TABLE #TEMP_NEWRECRUIT;
DROP TABLE #TEMP_MG_AGENTDATA2_V_ADHOC;
