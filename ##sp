
DECLARE @CurrentDate DATE = GETDATE()

IF DAY(@CurrentDate)=1
BEGIN

IF OBJECT_ID('TEMPDB..#TEMP_NEWRECRUIT ') IS NOT NULL 
BEGIN
  DROP TABLE #TEMP_NEWRECRUIT  
END

SELECT A.AGENT_ID [AGENTID],AGENT_NAME,  EFFECTIVEDATE=NEWRECRUIT_EFFECTIVEDATE   
 ,PERIODE = CONVERT(VARCHAR(6),NEWRECRUIT_EFFECTIVEDATE,112)  
INTO #TEMP_NEWRECRUIT 
FROM  DM_AGENTS A WITH (NOLOCK)   
  
WHERE  1=1   
AND CONVERT(VARCHAR(6),NEWRECRUIT_EFFECTIVEDATE,112) =CONVERT(VARCHAR(6), DATEADD(MONTH,-1,GETDATE()),112)  

END

ELSE
BEGIN
IF OBJECT_ID('TEMPDB..#TEMP_NEWRECRUIT ') IS NOT NULL 
BEGIN
  DROP TABLE #TEMP_NEWRECRUIT  
END

SELECT A.AGENT_ID [AGENTID],AGENT_NAME,  EFFECTIVEDATE=NEWRECRUIT_EFFECTIVEDATE   
 ,PERIODE = CONVERT(VARCHAR(6),NEWRECRUIT_EFFECTIVEDATE,112)  
INTO #TEMP_NEWRECRUIT 
FROM  DM_AGENTS A WITH (NOLOCK)   
  
WHERE  1=1   
AND CONVERT(VARCHAR(6),NEWRECRUIT_EFFECTIVEDATE,112) =CONVERT(VARCHAR(6), DATEADD(MONTH,0,GETDATE()),112)  

END

IF OBJECT_ID('TEMPDB..#TEMP_MG_AGENTDATA2_V_ADHOC ') IS NOT NULL 
BEGIN
  DROP TABLE #TEMP_MG_AGENTDATA2_V_ADHOC  
END

SELECT DISTINCT AGENTID,TUNJANGANFLAG INTO #TEMP_MG_AGENTDATA2_V_ADHOC FROM MG_AGENTDATA2_V_ADHOC


IF OBJECT_ID('TEMPDB..#RESULT ') IS NOT NULL 
BEGIN
  DROP TABLE #RESULT  
END

SELECT
 AG.AGENT_ID AS 'AGENTID'
,AG.NEWRECRUIT_EFFECTIVEDATE AS 'EFFECTIVEDATE'
,AG2.AGENT_NAME AS 'Agent Name'
,AG2.AGENT_STATUS AS 'Status'
,AG2.AGENT_LEVEL AS 'Agent Level'
,AG2.FWO_ID AS 'FWO'
,AG2.FWO AS 'FWO Name'
,AG2.FWM_ID AS 'FWM'
,AG2.FWM AS 'FWM Name'
,AG2.FWD_ID AS 'FWD'
,AG2.FWD AS 'FWD Name'
,AG2.RECRUITER_ID AS 'Recruiter'
,AG2.RECRUITER AS 'Recruiter Name'
,RC.AGENT_LEVEL AS 'Recruiter Level'
,AG2.SD AS 'AH'
,AG2.NSD AS 'RAH'
,AG2.JUMBO AS 'Jumbo'
,AG2.JUMBO AS 'Branch'
,AG2.REGION AS 'Region'
,AGR.TUNJANGANFLAG AS 'Tunjangan Agent'
,AGR1.TUNJANGANFLAG AS 'Tunjangan Recruiter'
INTO #RESULT
FROM #TEMP_NEWRECRUIT A LEFT JOIN
(SELECT * FROM DM_AGENTS 
--WHERE AGENT_ID IN (
-- '10039320','10039516','10039371','10039295','10039374'		-- DATA UAT
--,'10039621','10039578','10039605','10039500')
)AG 
ON A.AGENTID=AG.AGENT_ID
LEFT JOIN DM_AGENT_2 AG2 ON AG.AGENT_ID=AG2.AGENT_ID
LEFT JOIN DM_AGENTS RC ON AG2.RECRUITER_ID=RC.AGENT_ID
--LEFT JOIN DM_AGENT_2 SD ON SD.SD_ID=AG.AGENT_ID
--LEFT JOIN (SELECT DISTINCT AGENTID, TUNJANGANFLAG FROM DBReport..TEMP_AGENTDATA_REPTOOLS) AGR ON AD.AGENTID=AG.AGENT_ID
--LEFT JOIN (SELECT DISTINCT AGENTID, TUNJANGANFLAG FROM DBReport..TEMP_AGENTDATA_REPTOOLS) AGR1 ON AD.AGENTID=RC.AGENT_ID
LEFT JOIN #TEMP_MG_AGENTDATA2_V_ADHOC AGR ON AGR.AGENTID=AG.AGENT_ID
LEFT JOIN #TEMP_MG_AGENTDATA2_V_ADHOC AGR1 ON AGR1.AGENTID=RC.AGENT_ID
ORDER BY AG.NEWRECRUIT_EFFECTIVEDATE,AG.AGENT_ID

 IF (SELECT COUNT(*) FROM #RESULT) > 0     
 BEGIN     
 SELECT * FROM #RESULT 
 ORDER BY EFFECTIVEDATE,AGENTID
 END     
 ELSE      
BEGIN      
     
SELECT  [AGENTID]=NULL, [EFFECTIVEDATE]=NULL ,[Agent Name] =NULL, [Status]=NULL, [Agent Level]=NULL, [FWO]=NULL, [FWO Name]=NULL
, [FWM]=NULL, [FWM Name]=NULL, [FWD]=NULL, [FWD Name]=NULL, [Recruiter]=NULL, [Recruiter Name]= NULL, [Recruiter Level]=NULL
,[AH]=NULL, [RAH]=NULL, [Jumbo]=NULL, [Region]=NULL, [Tunjangan Agent]=NULL, [Tunjangan Recruiter]=NULL
     
END     
DROP TABLE #RESULT;
