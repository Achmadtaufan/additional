-- Menampung nama Linked Server
DECLARE @LinkedServers TABLE (ServerName SYSNAME);

-- Mendapatkan semua Linked Server
INSERT INTO @LinkedServers (ServerName)
SELECT name
FROM sys.servers
WHERE is_linked = 1;

-- Menampung nama database
DECLARE @DatabaseName SYSNAME;

-- Cursor untuk iterasi setiap database
DECLARE db_cursor CURSOR FOR
SELECT name
FROM sys.databases
WHERE state_desc = 'ONLINE'; -- Hanya database yang online

-- Variable untuk menampung hasil sementara
DECLARE @Sql NVARCHAR(MAX);
DECLARE @ServerName SYSNAME;
DECLARE @UserToImpersonate SYSNAME = 'svc_dwh';
DECLARE @Results TABLE (
    DatabaseName SYSNAME,
    ObjectType NVARCHAR(60),
    ObjectName SYSNAME
);

-- Membuka cursor database
OPEN db_cursor;
FETCH NEXT FROM db_cursor INTO @DatabaseName;

WHILE @@FETCH_STATUS = 0
BEGIN
    BEGIN TRY
        -- Mengubah konteks keamanan ke pengguna yang diimpersonasi
        SET @Sql = N'
        EXECUTE AS USER = ''' + @UserToImpersonate + ''';
        USE [' + @DatabaseName + '];

        SELECT ''' + @DatabaseName + ''' AS DatabaseName;';
        
        EXEC sp_executesql @Sql;

        -- Untuk setiap linked server
        DECLARE ls_cursor CURSOR FOR
        SELECT ServerName
        FROM @LinkedServers;

        OPEN ls_cursor;
        FETCH NEXT FROM ls_cursor INTO @ServerName;

        WHILE @@FETCH_STATUS = 0
        BEGIN
            -- Mencari linked server di dalam SP, View, dan Function
            SET @Sql = N'
            EXECUTE AS USER = ''' + @UserToImpersonate + ''';
            USE [' + @DatabaseName + '];

            INSERT INTO @Results (DatabaseName, ObjectType, ObjectName)
            SELECT DISTINCT
                ''' + @DatabaseName + ''' AS DatabaseName,
                o.type_desc AS ObjectType,
                o.name AS ObjectName
            FROM sys.sql_modules m
            INNER JOIN sys.objects o ON m.object_id = o.object_id
            WHERE m.definition LIKE ''%['' + @ServerName + '']%''
               OR m.definition LIKE ''%['' + @ServerName + '.]%''
               OR m.definition LIKE ''%'' + @ServerName + ''%''
               OR m.definition LIKE ''%['' + @ServerName + ']%''
               OR m.definition LIKE ''%['' + @ServerName + '.]%''
               OR m.definition LIKE ''%['' + @ServerName + ']%''
               OR m.definition LIKE ''%' + @ServerName + '.%''
               OR m.definition LIKE ''%[' + @ServerName + ']%''
               OR m.definition LIKE ''%[' + @ServerName + '.%''
               OR m.definition LIKE ''%[' + @ServerName + '.]%''
               OR m.definition LIKE ''%' + @ServerName + '%'';';

            -- Menjalankan query dinamis
            EXEC sp_executesql @Sql, N'@ServerName SYSNAME', @ServerName;

            FETCH NEXT FROM ls_cursor INTO @ServerName;
        END;

        CLOSE ls_cursor;
        DEALLOCATE ls_cursor;
    END TRY
    BEGIN CATCH
        -- Menangani kesalahan jika tidak dapat mengakses database
        PRINT 'Cannot access database: ' + @DatabaseName;
    END CATCH;

    FETCH NEXT FROM db_cursor INTO @DatabaseName;
END;

CLOSE db_cursor;
DEALLOCATE db_cursor;

-- Menampilkan hasil
SELECT *
FROM @Results
ORDER BY DatabaseName, ObjectType, ObjectName;
