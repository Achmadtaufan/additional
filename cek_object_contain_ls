-- Menampung nama Linked Server
DECLARE @LinkedServers TABLE (ServerName SYSNAME);

-- Mendapatkan semua Linked Server
INSERT INTO @LinkedServers (ServerName)
SELECT name
FROM sys.servers
WHERE is_linked = 1;

-- Menampung nama database
DECLARE @DatabaseName SYSNAME;

-- Cursor untuk iterasi setiap database
DECLARE db_cursor CURSOR FOR
SELECT name
FROM sys.databases
WHERE state_desc = 'ONLINE'; -- Hanya database yang online

-- Variable untuk menampung hasil sementara
DECLARE @Sql NVARCHAR(MAX);
DECLARE @ServerName SYSNAME;

-- Membuka cursor database
OPEN db_cursor;
FETCH NEXT FROM db_cursor INTO @DatabaseName;

WHILE @@FETCH_STATUS = 0
BEGIN
    -- Untuk setiap linked server
    DECLARE ls_cursor CURSOR FOR
    SELECT ServerName
    FROM @LinkedServers;

    OPEN ls_cursor;
    FETCH NEXT FROM ls_cursor INTO @ServerName;

    WHILE @@FETCH_STATUS = 0
    BEGIN
        -- Mencari linked server di dalam SP, View, dan Function
        SET @Sql = N'
        USE [' + @DatabaseName + '];

        SELECT DISTINCT
            ''' + @DatabaseName + ''' AS DatabaseName,
            o.name AS ObjectName,
            o.type_desc AS ObjectType
        FROM sys.sql_modules m
        INNER JOIN sys.objects o ON m.object_id = o.object_id
        WHERE m.definition LIKE ''%' + @ServerName + '%'';';

        -- Menjalankan query dinamis
        EXEC sp_executesql @Sql;

        FETCH NEXT FROM ls_cursor INTO @ServerName;
    END;

    CLOSE ls_cursor;
    DEALLOCATE ls_cursor;

    FETCH NEXT FROM db_cursor INTO @DatabaseName;
END;

CLOSE db_cursor;
DEALLOCATE db_cursor;
