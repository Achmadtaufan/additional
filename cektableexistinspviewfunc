DECLARE @TableName NVARCHAR(128) = 'product';
DECLARE @SQL NVARCHAR(MAX);

-- Build the SQL to search across all databases
SET @SQL = '
DECLARE @DatabaseName NVARCHAR(128);

-- Cursor to iterate through each database
DECLARE db_cursor CURSOR FOR 
SELECT name 
FROM sys.databases
WHERE name NOT IN (''master'', ''tempdb'', ''model'', ''msdb''); -- Exclude system databases

OPEN db_cursor;
FETCH NEXT FROM db_cursor INTO @DatabaseName;

WHILE @@FETCH_STATUS = 0
BEGIN
    -- Check if the user svc_dwh has access to the current database
    IF EXISTS (
        SELECT 1
        FROM [' + @DatabaseName + '].sys.database_permissions dp
        JOIN [' + @DatabaseName + '].sys.database_principals dp2 ON dp.grantee_principal_id = dp2.principal_id
        WHERE dp2.name = ''svc_dwh'' AND dp.permission_name IN (''SELECT'', ''EXECUTE'')
    )
    BEGIN
        -- Searching in stored procedures
        SELECT 
            ''' + @DatabaseName + ''' AS DatabaseName,
            ''Procedure'' AS ObjectType,
            OBJECT_NAME(OBJECT_ID) AS ObjectName
        FROM 
            [' + @DatabaseName + '].sys.procedures
        WHERE 
            OBJECT_DEFINITION(OBJECT_ID) LIKE ''%' + @TableName + '%''

        UNION ALL

        -- Searching in functions
        SELECT 
            ''' + @DatabaseName + ''' AS DatabaseName,
            ''Function'' AS ObjectType,
            OBJECT_NAME(OBJECT_ID) AS ObjectName
        FROM 
            [' + @DatabaseName + '].sys.objects
        WHERE 
            type IN (''FN'', ''IF'', ''TF'') -- scalar, inline, and table-valued functions
            AND OBJECT_DEFINITION(OBJECT_ID) LIKE ''%' + @TableName + '%''

        UNION ALL

        -- Searching in views
        SELECT 
            ''' + @DatabaseName + ''' AS DatabaseName,
            ''View'' AS ObjectType,
            OBJECT_NAME(OBJECT_ID) AS ObjectName
        FROM 
            [' + @DatabaseName + '].sys.views
        WHERE 
            OBJECT_DEFINITION(OBJECT_ID) LIKE ''%' + @TableName + '%''

        UNION ALL

        -- Searching in SQL modules for views
        SELECT 
            ''' + @DatabaseName + ''' AS DatabaseName,
            ''View'' AS ObjectType,
            OBJECT_NAME(OBJECT_ID) AS ObjectName
        FROM 
            [' + @DatabaseName + '].sys.sql_modules
        WHERE 
            OBJECT_DEFINITION(OBJECT_ID) LIKE ''%' + @TableName + '%'' AND 
            OBJECT_ID IN (SELECT OBJECT_ID FROM [' + @DatabaseName + '].sys.views)
    END

    FETCH NEXT FROM db_cursor INTO @DatabaseName;
END

CLOSE db_cursor;
DEALLOCATE db_cursor;
';

-- Execute the dynamic SQL
EXEC sp_executesql @SQL;
