-- Membuat temporary table untuk menyimpan nama link server
CREATE TABLE #LinkServers (LinkServerName NVARCHAR(100))

-- Memasukkan nama link server yang dimiliki oleh server idnlolita ke dalam temporary table
INSERT INTO #LinkServers (LinkServerName)
SELECT name
FROM sys.servers
WHERE is_linked = 1

-- Membuat temporary table untuk menyimpan hasil pencarian objek
CREATE TABLE #ObjectsWithLinkServer (ObjectName NVARCHAR(100), ObjectType NVARCHAR(50), LinkServerUsed NVARCHAR(100))

-- Membuat temporary table untuk menyimpan database yang dapat diakses oleh user svc_dwh
CREATE TABLE #AccessibleDatabases (DatabaseName NVARCHAR(100))

-- Memasukkan nama database yang dapat diakses oleh user svc_dwh ke dalam temporary table
INSERT INTO #AccessibleDatabases (DatabaseName)
SELECT d.name
FROM sys.databases d
WHERE NOT EXISTS (
    SELECT 1
    FROM sys.database_principals dp
    JOIN sys.server_principals sp ON dp.sid = sp.sid
    WHERE dp.name = 'svc_dwh' AND sp.type_desc = 'SQL_USER'
    ) OR NOT EXISTS (
    SELECT 1
    FROM sys.database_role_members drm
    JOIN sys.database_principals dp ON drm.member_principal_id = dp.principal_id
    JOIN sys.server_principals sp ON dp.sid = sp.sid
    WHERE sp.name = 'svc_dwh'
    )

-- Loop melalui setiap link server
DECLARE @LinkServerName NVARCHAR(100)
DECLARE link_cursor CURSOR FOR
SELECT LinkServerName
FROM #LinkServers

OPEN link_cursor
FETCH NEXT FROM link_cursor INTO @LinkServerName

WHILE @@FETCH_STATUS = 0
BEGIN
    -- Loop melalui setiap objek dalam setiap database
    DECLARE @DatabaseName NVARCHAR(100)
    DECLARE @SQL NVARCHAR(MAX)

    DECLARE db_cursor CURSOR FOR
    SELECT name
    FROM sys.databases
    WHERE state_desc = 'ONLINE' AND name NOT IN (SELECT DatabaseName FROM #AccessibleDatabases)

    OPEN db_cursor
    FETCH NEXT FROM db_cursor INTO @DatabaseName

    WHILE @@FETCH_STATUS = 0
    BEGIN
        SET @SQL = '
            USE ' + QUOTENAME(@DatabaseName) + ';

            INSERT INTO #ObjectsWithLinkServer (ObjectName, ObjectType, LinkServerUsed)
            SELECT 
                QUOTENAME(OBJECT_SCHEMA_NAME(objects.object_id)) + ''.'' + QUOTENAME(objects.name) AS ObjectName,
                objects.type_desc AS ObjectType,
                @LinkServerName AS LinkServerUsed
            FROM sys.objects
            CROSS APPLY sys.dm_sql_referenced_entities(OBJECT_SCHEMA_NAME(objects.object_id) + ''.'' + objects.name, ''OBJECT'') AS entities
            WHERE 
                objects.type IN (''V'', ''P'', ''FN'', ''IF'') AND
                entities.referenced_server_name = @LinkServerName
        '

        EXEC sp_executesql @SQL, N'@LinkServerName NVARCHAR(100)', @LinkServerName

        FETCH NEXT FROM db_cursor INTO @DatabaseName
    END

    CLOSE db_cursor
    DEALLOCATE db_cursor

    FETCH NEXT FROM link_cursor INTO @LinkServerName
END

CLOSE link_cursor
DEALLOCATE link_cursor

-- Menampilkan hasil pencarian
SELECT *
FROM #ObjectsWithLinkServer

-- Menghapus temporary tables
DROP TABLE #LinkServers
DROP TABLE #ObjectsWithLinkServer
DROP TABLE #AccessibleDatabases
